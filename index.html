<!DOCTYPE html>
<html>
<head>
    <title>Trash Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="camera-container">
        <div class="camera-viewport">
            <button id="startCamera">Start Camera</button>
            <video id="video" autoplay playsinline></video>
            <img id="photo">
            <div class="focus-frame"></div>
            <div id="result" class="result-overlay">
                <button class="close-button">Ã—</button>
                <div id="result-content"></div>
            </div>
        </div>

        <div class="bottom-controls">
            <button id="capture" class="shutter-button" disabled></button>
            <button id="retake" class="action-button">Retake</button>
            <button id="analyze" class="action-button">Analyze</button>
        </div>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>
    
    <script>
        const startButton = document.getElementById('startCamera');
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture');
        const retakeButton = document.getElementById('retake');
        const analyzeButton = document.getElementById('analyze');
        const photo = document.getElementById('photo');
        const canvas = document.getElementById('canvas');

        // Hide action buttons initially
        retakeButton.style.display = 'none';
        analyzeButton.style.display = 'none';

        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: false
                });
                video.srcObject = stream;
                video.classList.add('active');
                startButton.style.display = 'none';
                captureButton.disabled = false;
            } catch (err) {
                console.error('Error:', err);
                alert('Could not access camera');
            }
        });

        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            photo.src = canvas.toDataURL('image/jpeg');
            
            // Hide camera, show photo
            video.classList.remove('active');
            photo.style.display = 'block';
            photo.classList.add('active');
            
            // Hide shutter button, show action buttons
            captureButton.style.display = 'none';
            retakeButton.style.display = 'block';
            analyzeButton.style.display = 'block';
        });

        retakeButton.addEventListener('click', () => {
            // Show camera, hide photo
            video.classList.add('active');
            photo.classList.remove('active');
            photo.style.display = 'none';
            
            // Show shutter button, hide action buttons
            captureButton.style.display = 'block';
            retakeButton.style.display = 'none';
            analyzeButton.style.display = 'none';
        });

        analyzeButton.addEventListener('click', async () => {
            try {
                // Show loading state
                analyzeButton.disabled = true;
                analyzeButton.textContent = 'Analyzing...';
                
                // Get the image data
                const imageData = photo.src;
                
                // Send to server
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display the result
                const resultDiv = document.getElementById('result');
                const resultContent = document.getElementById('result-content');
                resultContent.innerHTML = marked.parse(data.analysis);
                resultDiv.style.display = 'block';
                
            } catch (err) {
                console.error('Error:', err);
                alert('Analysis failed: ' + err.message);
            } finally {
                // Reset button state
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analyze';
            }
        });

        // Add close button functionality
        document.querySelector('.close-button').addEventListener('click', () => {
            document.getElementById('result').style.display = 'none';
        });
    </script>
</body>
</html>